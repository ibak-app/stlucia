<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEV: Image Gallery &mdash; St. Lucia Business Guide</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    :root{--bg:#f5f5f7;--card:#fff;--text:#1d1d1f;--muted:#6e6e73;--accent:#0071e3;--border:#d2d2d7;--tag-bg:#e8e8ed;--red:#ff3b30;--green:#34c759;--orange:#ff9500;--shadow:rgba(0,0,0,.08);--primary:#1a5276;--primary-dark:#0e2f44}
    @media(prefers-color-scheme:dark){:root{--bg:#1d1d1f;--card:#2d2d2f;--text:#f5f5f7;--muted:#98989d;--accent:#2997ff;--border:#424245;--tag-bg:#3a3a3c;--red:#ff453a;--green:#30d158;--orange:#ff9f0a;--shadow:rgba(0,0,0,.3);--primary:#2997ff;--primary-dark:#1d6fa5}}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}

    /* Login */
    .login-overlay{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center}
    .login-overlay.hidden{display:none}
    .login-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:48px 40px;width:100%;max-width:400px;box-shadow:0 8px 32px var(--shadow)}
    .login-box h1{font-size:22px;font-weight:700;margin-bottom:4px;text-align:center}
    .login-box p{font-size:13px;color:var(--muted);text-align:center;margin-bottom:28px}
    .login-box .lock-icon{text-align:center;font-size:40px;margin-bottom:16px;opacity:.6}
    .login-field{margin-bottom:16px}
    .login-field label{display:block;font-size:13px;font-weight:600;margin-bottom:4px;color:var(--muted)}
    .login-field input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:15px;outline:none}
    .login-field input:focus{border-color:var(--accent)}
    .login-btn{width:100%;padding:12px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:8px}
    .login-btn:hover{opacity:.85}
    .login-error{color:var(--red);font-size:13px;text-align:center;margin-top:12px;display:none}

    /* App */
    .app{display:none}.app.visible{display:block}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 24px;position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between}
    .header-left h1{font-size:18px;font-weight:600}
    .header-left .stats{font-size:12px;color:var(--muted)}
    .header-left .stats span{margin-right:14px}
    .header-right{display:flex;align-items:center;gap:10px}
    .header-right .user{font-size:12px;color:var(--muted)}
    .icon-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--text);transition:all .2s}
    .icon-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .icon-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .logout-btn{padding:5px 12px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);font-size:12px;cursor:pointer}
    .logout-btn:hover{background:var(--red);color:#fff;border-color:var(--red)}

    .toolbar{background:var(--card);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;position:sticky;top:56px;z-index:99}
    .toolbar input,.toolbar select{padding:7px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:13px}
    .toolbar input{flex:1;min-width:180px}
    .toolbar select{min-width:120px}

    /* Page sections */
    .content{max-width:900px;margin:0 auto;padding:24px}
    .page-section{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:20px;overflow:hidden}
    .page-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none}
    .page-header:hover{background:var(--tag-bg)}
    .page-header h2{font-size:15px;font-weight:600}
    .page-header .badge{font-size:11px;padding:2px 10px;border-radius:12px;background:var(--tag-bg);color:var(--muted)}
    .page-header .chevron{font-size:12px;color:var(--muted);transition:transform .2s}
    .page-section.collapsed .page-body{display:none}
    .page-section.collapsed .chevron{transform:rotate(-90deg)}
    .page-body{padding:20px}

    /* Image context layouts - mimic the actual site */
    .img-block{margin-bottom:24px;position:relative}
    .img-block:last-child{margin-bottom:0}

    /* Hero layout */
    .ctx-hero{border-radius:10px;overflow:hidden;position:relative;height:200px;display:flex;align-items:flex-end}
    .ctx-hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .ctx-hero .overlay{position:relative;z-index:1;width:100%;padding:20px 24px;background:linear-gradient(transparent,rgba(0,0,0,.7));color:#fff}
    .ctx-hero .overlay h3{font-size:16px;font-weight:700}
    .ctx-hero .overlay p{font-size:11px;opacity:.8}

    /* Section layout */
    .ctx-section{border-radius:10px;overflow:hidden}
    .ctx-section img{width:100%;display:block;border-radius:10px}
    .ctx-section .caption{font-size:12px;color:var(--muted);margin-top:6px;font-style:italic}

    /* Float layout */
    .ctx-float{overflow:hidden}
    .ctx-float img{float:right;width:38%;max-width:240px;margin:0 0 12px 16px;border-radius:8px}
    .ctx-float .mock-text{font-size:12px;color:var(--muted);line-height:1.7}
    .ctx-float::after{content:'';display:table;clear:both}

    /* Card layout */
    .ctx-card{display:inline-block;width:200px;border:1px solid var(--border);border-radius:10px;overflow:hidden;vertical-align:top}
    .ctx-card img{width:100%;height:120px;object-fit:cover;display:block}
    .ctx-card .card-label{padding:8px 10px;font-size:11px;font-weight:600;color:var(--muted)}

    /* Map layout */
    .ctx-map{text-align:center}
    .ctx-map img{max-width:70%;border-radius:8px;border:1px solid var(--border)}
    .ctx-map .caption{font-size:12px;color:var(--muted);margin-top:6px;font-style:italic}

    /* Image overlay actions */
    .img-actions{position:absolute;top:8px;right:8px;display:flex;gap:6px;opacity:0;transition:opacity .2s}
    .img-block:hover .img-actions{opacity:1}
    .img-act{padding:4px 10px;border-radius:6px;border:none;font-size:11px;font-weight:600;cursor:pointer;backdrop-filter:blur(8px)}
    .img-act-replace{background:rgba(0,113,227,.85);color:#fff}
    .img-act-replace:hover{background:rgba(0,113,227,1)}
    .img-act-info{background:rgba(0,0,0,.55);color:#fff}
    .img-act-info:hover{background:rgba(0,0,0,.75)}
    .img-meta{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .img-meta .tag{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--tag-bg);color:var(--muted)}
    .img-meta .fname{font-size:11px;color:var(--muted);font-family:monospace}
    .img-meta .fsize{font-size:10px;color:var(--muted)}

    /* Settings panel */
    .settings-panel{display:none;background:var(--card);border:1px solid var(--border);border-radius:12px;position:fixed;top:56px;right:24px;z-index:150;width:360px;box-shadow:0 8px 32px var(--shadow);padding:20px}
    .settings-panel.open{display:block}
    .settings-panel h3{font-size:15px;font-weight:600;margin-bottom:12px}
    .settings-panel label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    .settings-panel input{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:13px;margin-bottom:12px;font-family:monospace}
    .settings-panel .hint{font-size:11px;color:var(--muted);margin-top:-8px;margin-bottom:12px}
    .gh-status{font-size:12px;padding:6px 10px;border-radius:6px;margin-top:4px}
    .gh-status.ok{background:#e8f5e9;color:#2e7d32}
    .gh-status.err{background:#ffebee;color:var(--red)}
    .gh-status.none{background:var(--tag-bg);color:var(--muted)}

    /* Modals */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;justify-content:center;align-items:flex-start;padding:40px 20px;overflow-y:auto;backdrop-filter:blur(4px)}
    .modal-overlay.active{display:flex}
    .modal{background:var(--card);border-radius:16px;width:100%;max-width:660px;box-shadow:0 16px 48px rgba(0,0,0,.2);overflow:hidden}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{font-size:16px;font-weight:600}
    .modal-close{width:28px;height:28px;border:none;background:var(--tag-bg);border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--text)}
    .modal-close:hover{background:var(--red);color:#fff}
    .modal-body{padding:20px}
    .modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

    /* Replace modal */
    .replace-compare{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
    .replace-side{background:var(--bg);border-radius:10px;padding:10px;text-align:center}
    .replace-side h4{font-size:12px;font-weight:600;margin-bottom:6px;color:var(--muted)}
    .replace-side img{max-width:100%;max-height:160px;border-radius:8px;object-fit:cover}
    .replace-side .placeholder{height:160px;display:flex;align-items:center;justify-content:center;border:2px dashed var(--border);border-radius:8px;color:var(--muted);font-size:12px}
    .drop-zone{border:2px dashed var(--border);border-radius:10px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px}
    .drop-zone:hover,.drop-zone.drag-over{border-color:var(--accent);background:rgba(0,113,227,.05)}
    .drop-zone p{font-size:13px;color:var(--muted)}
    .drop-zone .browse{color:var(--accent);font-weight:600;text-decoration:underline;cursor:pointer}
    .replace-options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
    .replace-options label{font-size:12px;color:var(--muted);display:block;margin-bottom:3px}
    .replace-options input,.replace-options select{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:12px}
    .replace-status{font-size:12px;padding:8px 12px;border-radius:8px;margin-top:10px;display:none}
    .replace-status.success{display:block;background:#e8f5e9;color:#2e7d32}
    .replace-status.error{display:block;background:#ffebee;color:var(--red)}
    .replace-status.info{display:block;background:#e3f2fd;color:#1565c0}
    .btn-primary{padding:8px 20px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:13px;font-weight:600;cursor:pointer}
    .btn-primary:hover{opacity:.85}
    .btn-primary:disabled{opacity:.4;cursor:not-allowed}
    .btn-secondary{padding:8px 20px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);font-size:13px;cursor:pointer}
    .btn-secondary:hover{background:var(--bg)}
    .btn-github{background:#2ea043;color:#fff;border:none;padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
    .btn-github:hover{background:#238636}
    .btn-github:disabled{opacity:.4;cursor:not-allowed}

    .lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;justify-content:center;align-items:center;cursor:zoom-out}
    .lightbox.active{display:flex}
    .lightbox img{max-width:90vw;max-height:90vh;border-radius:8px}

    .empty{text-align:center;padding:60px 24px;color:var(--muted);font-size:15px}

    @media(max-width:700px){
      .content{padding:12px}
      .toolbar{padding:8px 12px}
      .ctx-float img{float:none;width:100%;max-width:100%;margin:0 0 10px 0}
      .ctx-card{width:100%}
      .replace-compare,.replace-options{grid-template-columns:1fr}
      .login-box{padding:32px 24px;margin:16px}
      .settings-panel{right:12px;left:12px;width:auto}
    }
  </style>
</head>
<body>

<!-- Login -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="lock-icon">&#128274;</div>
    <h1>Dev Image Gallery</h1>
    <p>Restricted access. Enter your credentials to continue.</p>
    <form id="loginForm" onsubmit="return handleLogin(event)">
      <div class="login-field"><label>Email</label><input type="email" id="loginEmail" autocomplete="email" required placeholder="you@example.com"></div>
      <div class="login-field"><label>Password</label><input type="password" id="loginPassword" autocomplete="current-password" required placeholder="Enter password"></div>
      <button type="submit" class="login-btn">Sign In</button>
      <div class="login-error" id="loginError">Invalid email or password.</div>
    </form>
  </div>
</div>

<!-- App -->
<div class="app" id="app">
  <div class="header">
    <div class="header-left">
      <h1>Image Gallery</h1>
      <div class="stats" id="stats"></div>
    </div>
    <div class="header-right">
      <span class="user" id="userEmail"></span>
      <button class="icon-btn" id="settingsBtn" onclick="toggleSettings()" title="GitHub Settings">&#9881;</button>
      <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <div class="settings-panel" id="settingsPanel">
    <h3>GitHub Settings</h3>
    <label>Personal Access Token</label>
    <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx" oninput="saveToken()">
    <div class="hint">Needs <code>repo</code> scope. <a href="https://github.com/settings/tokens/new?scopes=repo&description=stlucia-dev-gallery" target="_blank" style="color:var(--accent)">Create token</a></div>
    <div class="gh-status none" id="ghStatus">No token set - image changes will download locally only</div>
  </div>

  <div class="toolbar">
    <input type="text" id="search" placeholder="Search filename, alt text, or page...">
    <select id="filterPage"><option value="">All Pages</option></select>
    <select id="filterType">
      <option value="">All Types</option>
      <option value="hero">Hero</option>
      <option value="section">Section</option>
      <option value="float">Float</option>
      <option value="card">Card</option>
      <option value="map">Map</option>
      <option value="unused">Unused</option>
    </select>
  </div>

  <div class="content" id="content"></div>
  <div class="empty" id="empty" style="display:none">No images match your filters.</div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('active')"><img id="lightbox-img" src="" alt=""></div>

<!-- Replace Modal -->
<div class="modal-overlay" id="replaceModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="replaceTitle">Replace Image</h2>
      <button class="modal-close" onclick="closeModal('replaceModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="replace-compare">
        <div class="replace-side"><h4>Current</h4><img id="replaceCurrent" src="" alt=""></div>
        <div class="replace-side"><h4>New</h4><div class="placeholder" id="replaceNewPlaceholder">No image selected</div><img id="replaceNew" src="" alt="" style="display:none"></div>
      </div>
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <p>Drag & drop an image here, or <span class="browse">browse</span></p>
        <p style="font-size:11px;margin-top:4px">JPG, PNG, WebP &mdash; max 5 MB</p>
        <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" style="display:none">
      </div>
      <div class="replace-options">
        <div><label>Max Width (px)</label><input type="number" id="optMaxWidth" value="1200" min="200" max="2400"></div>
        <div><label>Quality</label><input type="number" id="optQuality" value="80" min="10" max="100"></div>
        <div><label>Output Format</label><select id="optFormat"><option value="auto">Auto (match original)</option><option value="jpeg">JPEG</option><option value="png">PNG</option><option value="webp">WebP</option></select></div>
        <div><label>New Alt Text</label><input type="text" id="optAlt" placeholder="Leave blank to keep current"></div>
      </div>
      <div class="replace-status" id="replaceStatus"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal('replaceModal')">Cancel</button>
      <button class="btn-secondary" id="btnDownload" onclick="processImage('download')" disabled>Download</button>
      <button class="btn-github" id="btnCommit" onclick="processImage('commit')" disabled>Commit to GitHub</button>
    </div>
  </div>
</div>

<script>
// ── Auth ──
const AUTH_KEY='dev-gallery-auth';
const VALID={e:'hasan@ibak.app',p:'Biren9'};
function checkAuth(){const s=sessionStorage.getItem(AUTH_KEY);if(s===btoa(VALID.e)){showApp(VALID.e);return true}return false}
function handleLogin(e){e.preventDefault();const em=document.getElementById('loginEmail').value.trim(),pw=document.getElementById('loginPassword').value;if(em===VALID.e&&pw===VALID.p){sessionStorage.setItem(AUTH_KEY,btoa(em));showApp(em)}else{document.getElementById('loginError').style.display='block';document.getElementById('loginPassword').value=''}return false}
function handleLogout(){sessionStorage.removeItem(AUTH_KEY);document.getElementById('app').classList.remove('visible');document.getElementById('loginOverlay').classList.remove('hidden')}
function showApp(em){document.getElementById('loginOverlay').classList.add('hidden');document.getElementById('app').classList.add('visible');document.getElementById('userEmail').textContent=em;loadToken();render()}

// ── GitHub Token ──
const GH_TOKEN_KEY='dev-gallery-gh-token';
const REPO='ibak-app/stlucia';
const BRANCH='master';
function loadToken(){const t=sessionStorage.getItem(GH_TOKEN_KEY);if(t){document.getElementById('ghToken').value=t;updateGhStatus(true)}else{updateGhStatus(false)}}
function saveToken(){const t=document.getElementById('ghToken').value.trim();if(t){sessionStorage.setItem(GH_TOKEN_KEY,t);updateGhStatus(true)}else{sessionStorage.removeItem(GH_TOKEN_KEY);updateGhStatus(false)}}
function getToken(){return sessionStorage.getItem(GH_TOKEN_KEY)}
function updateGhStatus(has){const el=document.getElementById('ghStatus');const btn=document.getElementById('btnCommit');if(has){el.className='gh-status ok';el.textContent='Token set - you can commit directly to GitHub';if(btn)btn.disabled=false}else{el.className='gh-status none';el.textContent='No token - image changes will download locally only';if(btn)btn.disabled=true}}
function toggleSettings(){const p=document.getElementById('settingsPanel');p.classList.toggle('open');document.getElementById('settingsBtn').classList.toggle('active')}

// ── Image Data ──
const IMAGE_DATA=[
  {name:"Beausejour_Stadium_Cricket_St_Lucia.jpg",size:241310,pages:["events","tr/events"],alt:"Daren Sammy National Cricket Stadium, Gros Islet, Saint Lucia",type:"section"},
  {name:"business-bpo-office.jpg",size:28954,pages:["business","tr/business"],alt:"Business process outsourcing office in Castries, Saint Lucia",type:"float"},
  {name:"business-castries-district.jpg",size:94723,pages:["business","faq","tr/business","tr/faq"],alt:"Castries business district in Saint Lucia",type:"section"},
  {name:"business-eccb-building.webp",size:46140,pages:["business","tr/business"],alt:"Eastern Caribbean Central Bank headquarters",type:"float"},
  {name:"business-investment-meeting.jpg",size:41540,pages:["business","tr/business"],alt:"Business investment meeting in Saint Lucia",type:"section"},
  {name:"business-penny-pinch-wallet.jpg",size:17802,pages:["business","tr/business"],alt:"Penny Pinch mobile wallet, a Saint Lucia fintech success story",type:"float"},
  {name:"card-directory.jpg",size:211990,pages:["index","directory","tr/index","tr/directory"],alt:"Castries waterfront",type:"card"},
  {name:"card-legal.jpg",size:37482,pages:["index","tr/index"],alt:"Legal documents and gavel",type:"card"},
  {name:"card-map.jpg",size:83044,pages:["index","tr/index"],alt:"Saint Lucia map",type:"card"},
  {name:"card-overview.jpg",size:140261,pages:["index","tr/index"],alt:"Saint Lucia coastline aerial view",type:"card"},
  {name:"card-sectors.jpg",size:141829,pages:["index","tr/index"],alt:"Saint Lucia banana plantation",type:"card"},
  {name:"card-trade.jpg",size:111282,pages:["index","tr/index"],alt:"Caribbean shipping port",type:"card"},
  {name:"castries-central-market.jpg",size:49982,pages:["overview","trade","tr/overview","tr/trade"],alt:"Castries Central Market, a historic landmark in Saint Lucia",type:"float"},
  {name:"cbi-passport.webp",size:30848,pages:["index","cbi","tr/index","tr/cbi"],alt:"Caribbean passport and travel documents",type:"card"},
  {name:"cbi-realestate.jpg",size:45419,pages:["cbi","tr/cbi"],alt:"Caribbean luxury villa investment property",type:"float"},
  {name:"cbi-sovereign-wealth.jpg",size:44475,pages:["cbi","tr/cbi"],alt:"Saint Lucia Sovereign Wealth Fund and national investment management",type:"float"},
  {name:"cbi-stlucia-aerial-investment.jpg",size:42139,pages:["cbi","tr/cbi"],alt:"Aerial view of Saint Lucia coastline, a prime citizenship by investment destination",type:"float"},
  {name:"cbi-stlucia-passport.webp",size:37742,pages:["cbi","tr/cbi"],alt:"Saint Lucia passport obtained through citizenship by investment",type:"float"},
  {name:"checklist-business-planning.png",size:21903,pages:["checklist","tr/checklist"],alt:"Business planning and strategy for investing in Saint Lucia",type:"section"},
  {name:"checklist-compliance.webp",size:24648,pages:["checklist","tr/checklist"],alt:"Business compliance and regulatory requirements in Saint Lucia",type:"float"},
  {name:"checklist-entity-formation.jpg",size:27280,pages:["checklist","tr/checklist"],alt:"Company registration at the Registry of Companies, Saint Lucia",type:"float"},
  {name:"event-carnival.jpg",size:169114,pages:["index","events","tr/index","tr/events"],alt:"Saint Lucia Carnival parade celebration",type:"section"},
  {name:"events-carnival-stlucia.jpg",size:85342,pages:["events","tr/events"],alt:"Saint Lucia Carnival parade celebrations",type:"float"},
  {name:"events-creole-food.jpg",size:40276,pages:["events","tr/events"],alt:"Saint Lucian Creole cuisine and cultural food",type:"float"},
  {name:"events-gros-islet-party.jpg",size:205420,pages:["events","tr/events"],alt:"Gros Islet Friday night street party, Saint Lucia",type:"section"},
  {name:"events-jazz-festival.jpg",size:152606,pages:["events","tr/events"],alt:"Jazz and music festival performance in the Caribbean",type:"section"},
  {name:"events-jazz-stlucia.jpg",size:46549,pages:["events","tr/events"],alt:"Saint Lucia Jazz and Arts Festival performance",type:"float"},
  {name:"events-julien-alfred.jpg",size:23777,pages:["events","tr/events"],alt:"Julien Alfred, Saint Lucia Olympic gold medallist sprinter",type:"float"},
  {name:"events-sailing-caribbean.jpg",size:30716,pages:["events","tr/events"],alt:"Sailing and yachting in Caribbean waters",type:"float"},
  {name:"expats-driving-stlucia-road.jpg",size:58296,pages:["expats","tr/expats"],alt:"Scenic mountain road driving in Saint Lucia",type:"section"},
  {name:"expats-healthcare-okeu.jpg",size:82607,pages:["expats","tr/expats"],alt:"Owen King EU Hospital (OKEU), the main public hospital in Castries, Saint Lucia",type:"float"},
  {name:"expats-rodney-bay-village.jpg",size:65092,pages:["expats","faq","resources","tr/expats","tr/faq","tr/resources"],alt:"Rodney Bay Village, the main entertainment and dining hub for expats in Saint Lucia",type:"float"},
  {name:"government-house-stlucia.jpg",size:201966,pages:["government","tr/government"],alt:"Government House, official residence of the Governor-General of Saint Lucia",type:"section"},
  {name:"hero-business.jpg",size:57858,pages:["index","business","startups","tr/index","tr/business","tr/startups"],alt:"Caribbean business meeting",type:"hero"},
  {name:"hero-cbi.jpg",size:86245,pages:["index","cbi","realestate","tr/index","tr/cbi","tr/realestate"],alt:"Immigration / Real Estate hero",type:"hero"},
  {name:"hero-checklist.jpg",size:25153,pages:["index","checklist","tr/index","tr/checklist"],alt:"Business planning checklist",type:"hero"},
  {name:"hero-events.jpg",size:110449,pages:["events","tr/events"],alt:"Saint Lucia events hero",type:"hero"},
  {name:"hero-faq.jpg",size:112875,pages:["index","faq","tr/index","tr/faq"],alt:"Castries Central Market",type:"hero"},
  {name:"hero-legal.jpg",size:71938,pages:["immigration","legal","tr/immigration","tr/legal"],alt:"Legal / Immigration hero",type:"hero"},
  {name:"hero-living.jpg",size:287613,pages:["index","expats","living","tr/index","tr/expats","tr/living"],alt:"Saint Lucia lifestyle",type:"hero"},
  {name:"hero-overview.jpg",size:140171,pages:["overview","tr/overview"],alt:"Saint Lucia overview hero",type:"hero"},
  {name:"hero-pitons.jpg",size:175522,pages:["index","tr/index"],alt:"The Pitons, Saint Lucia",type:"hero"},
  {name:"hero-resources.webp",size:81948,pages:["index","resources","tr/index","tr/resources"],alt:"Reference resources and documents",type:"hero"},
  {name:"hero-sectors.jpg",size:205405,pages:["sectors","tr/sectors"],alt:"Saint Lucia luxury resort beach",type:"hero"},
  {name:"hero-trade.jpg",size:105698,pages:["trade","tr/trade"],alt:"Trade hero",type:"hero"},
  {name:"hewanorra-airport-new.jpg",size:51136,pages:["immigration","tr/immigration"],alt:"Hewanorra International Airport terminal expansion, Saint Lucia",type:"float"},
  {name:"hewanorra-airport.jpg",size:44999,pages:["overview","tr/overview"],alt:"Hewanorra International Airport, Saint Lucia",type:"float"},
  {name:"immigration-department-stlucia.jpg",size:47608,pages:["immigration","tr/immigration"],alt:"Immigration Department of Saint Lucia office",type:"float"},
  {name:"immigration-digital-nomad.jpg",size:141548,pages:["immigration","tr/immigration"],alt:"Digital nomad working remotely from a Caribbean beach",type:"section"},
  {name:"immigration-work-permit.jpg",size:29000,pages:["immigration","tr/immigration"],alt:"Work permit and employment visa processing, Saint Lucia",type:"section"},
  {name:"legal-castries-market-workers.jpg",size:59568,pages:["legal","tr/legal"],alt:"Workers and vendors at Castries Central Market, Saint Lucia",type:"section"},
  {name:"legal-courthouse-caribbean.jpg",size:214606,pages:["legal","tr/legal"],alt:"First District Court, Peynier Street, Castries, Saint Lucia",type:"section"},
  {name:"legal-eccb-office-castries.jpg",size:23552,pages:["legal","tr/legal"],alt:"Eastern Caribbean Central Bank agency office in Castries, Saint Lucia",type:"float"},
  {name:"legal-property-caribbean.jpg",size:80344,pages:["legal","faq","tr/legal","tr/faq"],alt:"Caribbean property and land registry",type:"float"},
  {name:"legal-tax-accounting.jpg",size:19218,pages:["legal","tr/legal"],alt:"Inland Revenue Department tax documentation, Saint Lucia",type:"float"},
  {name:"living-education-classroom.jpg",size:127301,pages:["living","tr/living"],alt:"Classroom and education in Saint Lucia",type:"section"},
  {name:"living-food.jpg",size:73424,pages:["living","tr/living"],alt:"Castries Market tropical fruits and produce",type:"float"},
  {name:"living-housing.jpg",size:40583,pages:["index","living","tr/index","tr/living"],alt:"Saint Lucia villa rental home",type:"float"},
  {name:"living-lucelec-plant.jpg",size:51242,pages:["living","tr/living"],alt:"LUCELEC power plant, Saint Lucia's electricity provider",type:"float"},
  {name:"living-lucelec-solar-farm.jpg",size:65621,pages:["living","tr/living"],alt:"LUCELEC solar farm, part of Saint Lucia's renewable energy expansion",type:"float"},
  {name:"living-telecom-tower.jpg",size:16896,pages:["living","tr/living"],alt:"FLOW and Digicel telecommunications infrastructure in Saint Lucia",type:"float"},
  {name:"living-transport-bus.jpg",size:55960,pages:["living","tr/living"],alt:"Colourful minibus public transport in Saint Lucia",type:"section"},
  {name:"living-victoria-hospital.jpg",size:27279,pages:["living","tr/living"],alt:"Victoria Hospital in Castries, Saint Lucia",type:"float"},
  {name:"marigot-bay-resort.jpg",size:60733,pages:["expats","tr/expats"],alt:"Marigot Bay resort, a popular expat area in Saint Lucia",type:"float"},
  {name:"overview-ec-dollar-currency.jpg",size:57493,pages:["overview","resources","tr/overview","tr/resources"],alt:"Eastern Caribbean dollar (EC$) banknote, the official currency of Saint Lucia",type:"section"},
  {name:"overview-rodney-bay-aerial.jpg",size:161557,pages:["overview","tr/overview"],alt:"Aerial view of Rodney Bay, Saint Lucia",type:"section"},
  {name:"overview-walcott-square.jpg",size:89121,pages:["overview","tr/overview"],alt:"Derek Walcott Square in Castries, Saint Lucia",type:"float"},
  {name:"pitons-landscape.jpg",size:195381,pages:["overview","tr/overview"],alt:"The Pitons, Saint Lucia UNESCO World Heritage Site",type:"section"},
  {name:"port-castries-cruise.jpg",size:60650,pages:["trade","tr/trade"],alt:"Port Castries cruise terminal, Saint Lucia",type:"section"},
  {name:"port-castries.jpg",size:37108,pages:["overview","tr/overview"],alt:"Port of Castries with cruise ships",type:"float"},
  {name:"realestate-construction.jpg",size:41260,pages:["realestate","tr/realestate"],alt:"Tropical building construction and development",type:"float"},
  {name:"realestate-luxury-resort.jpg",size:142733,pages:["realestate","tr/realestate"],alt:"Luxury Caribbean resort villa development",type:"section"},
  {name:"realestate-property-financing.jpg",size:37466,pages:["realestate","tr/realestate"],alt:"Property financing and mortgage options in Saint Lucia",type:"float"},
  {name:"realestate-sugar-beach.jpg",size:157753,pages:["realestate","tr/realestate"],alt:"Sugar Beach resort between the Pitons, Saint Lucia",type:"section"},
  {name:"realestate-villa-pitons.jpg",size:50936,pages:["realestate","tr/realestate"],alt:"Luxury villa with Pitons view in Saint Lucia",type:"float"},
  {name:"resources-stlucia-tourism.jpg",size:45139,pages:["resources","tr/resources"],alt:"Saint Lucia Tourism Authority promotional material",type:"section"},
  {name:"rodney-bay-marina.jpg",size:44468,pages:["expats","tr/expats"],alt:"Rodney Bay Marina, Saint Lucia",type:"float"},
  {name:"sector-agriculture.jpg",size:76625,pages:["sectors","tr/sectors"],alt:"Saint Lucia cocoa and chocolate production",type:"float"},
  {name:"sector-banana-plantation.jpg",size:58313,pages:["sectors","tr/sectors"],alt:"Banana plantation in Saint Lucia",type:"float"},
  {name:"sector-cocoa-farm.jpg",size:62774,pages:["sectors","tr/sectors"],alt:"Cocoa farm and chocolate production in Saint Lucia",type:"float"},
  {name:"sector-energy.jpg",size:63816,pages:["sectors","tr/sectors"],alt:"Solar panels in Caribbean tropical setting",type:"float"},
  {name:"sector-fishing-anse-la-raye.jpg",size:144754,pages:["sectors","tr/sectors"],alt:"Fishing boats on the beach at Anse La Raye, Saint Lucia",type:"section"},
  {name:"sector-maritime.jpg",size:44468,pages:["tr/sectors"],alt:"Yachts at Rodney Bay Marina",type:"float"},
  {name:"sector-pigeon-island-landmark.jpg",size:20354,pages:["tr/sectors"],alt:"Pigeon Island National Landmark, Saint Lucia",type:"float"},
  {name:"sector-technology.jpg",size:42063,pages:["sectors","tr/sectors"],alt:"BPO call center in the Caribbean",type:"float"},
  {name:"soufriere-pitons-town.jpg",size:77823,pages:["overview","tr/overview"],alt:"Soufriere town with view of the Pitons, Saint Lucia",type:"section"},
  {name:"startups-coworking.webp",size:35756,pages:["startups","tr/startups"],alt:"Coworking and innovation space in Saint Lucia",type:"float"},
  {name:"startups-ecommerce.jpg",size:55706,pages:["startups","tr/startups"],alt:"E-commerce and digital shopping in the Eastern Caribbean",type:"section"},
  {name:"startups-entrepreneurs.jpg",size:166800,pages:["startups","tr/startups"],alt:"Startup entrepreneurs meeting in the Caribbean",type:"section"},
  {name:"startups-incubator.jpg",size:41333,pages:["startups","tr/startups"],alt:"BOOST business incubator programme, Saint Lucia",type:"float"},
  {name:"startups-youth-entrepreneurship.jpg",size:42056,pages:["startups","tr/startups"],alt:"Youth Enterprise Agency (YEA) training programme, Saint Lucia",type:"float"},
  {name:"trade-caricom-leaders.jpg",size:53460,pages:["trade","tr/trade"],alt:"CARICOM Heads of Government meeting, Caribbean regional cooperation",type:"section"},
  {name:"trade-castries-port-cargo.webp",size:63108,pages:["trade","tr/trade"],alt:"Port of Castries cargo terminal and container shipping, Saint Lucia",type:"section"},
  {name:"trade-vieux-fort-aerial.jpg",size:49084,pages:["trade","tr/trade"],alt:"Aerial view of Vieux Fort industrial and free trade zone area, Saint Lucia",type:"float"},
  {name:"maps/map-administrative-districts.jpg",size:40450,pages:["overview","tr/overview"],alt:"Map of Saint Lucia's 10 administrative quarters and districts",type:"map"},
  {name:"maps/map-cities-locator.jpg",size:53171,pages:[],alt:"Map of Saint Lucia cities and boundaries",type:"map"},
  {name:"maps/map-detailed-topographic.jpg",size:46463,pages:[],alt:"Detailed topographic map of Saint Lucia",type:"map"},
  {name:"maps/map-electoral-constituencies.png",size:53570,pages:["government","tr/government"],alt:"Map of Saint Lucia's 17 electoral constituencies",type:"map"},
  {name:"maps/map-location-overview.jpg",size:51046,pages:["overview","tr/overview"],alt:"Map of Saint Lucia showing major cities, towns and geographical features",type:"map"},
  {name:"maps/map-marine-protected-areas.jpg",size:35506,pages:["sectors","tr/sectors"],alt:"Soufriere Marine Management Area (SMMA) zonation map, Saint Lucia",type:"map"},
  {name:"maps/map-parishes-quarters.png",size:138349,pages:[],alt:"Map of Saint Lucia parishes and quarters",type:"map"},
  {name:"maps/map-topographic-elevation.png",size:290149,pages:["living","tr/living"],alt:"Topographic elevation map of Saint Lucia showing mountainous terrain and coastal areas",type:"map"}
];

const MOCK='Saint Lucia offers investors a strategic Caribbean location with modern infrastructure, competitive incentives, and a stable democratic government. The island nation provides excellent opportunities across tourism, agriculture, financial services, and technology sectors.';
const PAGE_TITLES={index:'Home',overview:'Country Overview',business:'Business Environment',legal:'Legal & Tax Framework',sectors:'Key Sectors',cbi:'Citizenship by Investment',immigration:'Immigration & Visas',living:'Cost of Living',expats:'Expat Life',events:'Events & Culture',map:'Interactive Map',directory:'Business Directory',faq:'FAQ',resources:'Resources',trade:'Trade & CARICOM',checklist:'Investment Checklist',government:'Government',realestate:'Real Estate',startups:'Startups & Entrepreneurs',liked:'Liked Feed'};

function formatSize(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(0)+' KB';return(b/1048576).toFixed(1)+' MB'}
function getExt(n){return n.split('.').pop().toLowerCase()}
function getEnPages(){const s=new Set();IMAGE_DATA.forEach(i=>i.pages.filter(p=>!p.startsWith('tr/')).forEach(p=>s.add(p)));return[...s].sort()}

// ── Render image block in context ──
function imgBlock(i){
  const src='assets/images/'+i.name;
  const acts=`<div class="img-actions"><button class="img-act img-act-replace" onclick="event.stopPropagation();showReplace('${i.name}')">Replace</button><button class="img-act img-act-info" onclick="event.stopPropagation();openLightbox('${src}')">View</button></div>`;
  const meta=`<div class="img-meta"><span class="fname">${i.name}</span><span class="fsize">${formatSize(i.size)}</span><span class="tag">${getExt(i.name).toUpperCase()}</span></div>`;

  if(i.type==='hero'){
    return`<div class="img-block"><div class="ctx-hero">${acts}<img src="${src}" alt="${i.alt}" loading="lazy"><div class="overlay"><h3>${i.alt}</h3><p>Hero banner image</p></div></div>${meta}</div>`;
  }
  if(i.type==='section'){
    return`<div class="img-block"><div class="ctx-section" style="position:relative">${acts}<img src="${src}" alt="${i.alt}" loading="lazy"><div class="caption">${i.alt}</div></div>${meta}</div>`;
  }
  if(i.type==='float'){
    return`<div class="img-block"><div class="ctx-float" style="position:relative">${acts}<img src="${src}" alt="${i.alt}" loading="lazy"><div class="mock-text">${MOCK}</div></div>${meta}</div>`;
  }
  if(i.type==='card'){
    return`<div class="img-block" style="display:inline-block;margin-right:12px;margin-bottom:12px;vertical-align:top"><div class="ctx-card" style="position:relative">${acts}<img src="${src}" alt="${i.alt}" loading="lazy"><div class="card-label">${i.alt}</div></div>${meta}</div>`;
  }
  if(i.type==='map'){
    return`<div class="img-block"><div class="ctx-map" style="position:relative">${acts}<img src="${src}" alt="${i.alt}" loading="lazy"><div class="caption">${i.alt}</div></div>${meta}</div>`;
  }
  return`<div class="img-block"><div class="ctx-section" style="position:relative">${acts}<img src="${src}" alt="${i.alt}" loading="lazy"></div>${meta}</div>`;
}

// ── Main Render ──
function render(){
  const q=document.getElementById('search').value.toLowerCase();
  const filterPage=document.getElementById('filterPage').value;
  const filterType=document.getElementById('filterType').value;

  let items=[...IMAGE_DATA];
  if(q)items=items.filter(i=>i.name.toLowerCase().includes(q)||i.alt.toLowerCase().includes(q)||i.pages.some(p=>p.toLowerCase().includes(q)));
  if(filterType==='unused')items=items.filter(i=>i.pages.length===0);
  else if(filterType)items=items.filter(i=>i.type===filterType);
  if(filterPage)items=items.filter(i=>i.pages.includes(filterPage));

  const ct=document.getElementById('content');
  const em=document.getElementById('empty');

  if(items.length===0){ct.innerHTML='';em.style.display='block';return}
  em.style.display='none';

  // Group by EN page
  const grouped={};
  items.forEach(i=>{
    const enPages=i.pages.filter(p=>!p.startsWith('tr/'));
    if(enPages.length===0){
      // Unused or TR-only
      const key=i.pages.length===0?'_unused':'_tr_only';
      if(!grouped[key])grouped[key]=[];
      grouped[key].push(i);
    }else{
      enPages.forEach(p=>{
        if(!grouped[p])grouped[p]=[];
        if(!grouped[p].find(x=>x.name===i.name))grouped[p].push(i);
      });
    }
  });

  // Order: hero first, then section, float, card, map within each page
  const typeOrder={hero:0,section:1,float:2,card:3,map:4};
  Object.values(grouped).forEach(arr=>arr.sort((a,b)=>(typeOrder[a.type]||9)-(typeOrder[b.type]||9)));

  // Page order
  const pageOrder=['index','overview','business','legal','sectors','cbi','immigration','living','expats','events','government','realestate','startups','trade','checklist','faq','resources','directory','map','liked','_tr_only','_unused'];
  const sortedKeys=Object.keys(grouped).sort((a,b)=>{const ai=pageOrder.indexOf(a),bi=pageOrder.indexOf(b);return(ai===-1?99:ai)-(bi===-1?99:bi)});

  let html='';
  sortedKeys.forEach(page=>{
    const imgs=grouped[page];
    const title=page==='_unused'?'Unused Images':page==='_tr_only'?'Turkish Only':PAGE_TITLES[page]||page;
    const trCount=imgs.reduce((s,i)=>s+i.pages.filter(p=>p.startsWith('tr/')).length,0);
    const badge=page.startsWith('_')?imgs.length+' images':`${imgs.length} images &middot; also on ${trCount} TR pages`;

    html+=`<div class="page-section" data-page="${page}">
      <div class="page-header" onclick="this.parentElement.classList.toggle('collapsed')">
        <h2>${title} <a href="${page.startsWith('_')?'#':page+'.html'}" onclick="event.stopPropagation()" target="_blank" style="font-size:11px;color:var(--accent);margin-left:8px;font-weight:400;text-decoration:none">${page.startsWith('_')?'':'open &rarr;'}</a></h2>
        <div><span class="badge">${badge}</span> <span class="chevron">&#9660;</span></div>
      </div>
      <div class="page-body">${imgs.map(i=>imgBlock(i)).join('')}</div>
    </div>`;
  });
  ct.innerHTML=html;

  // Stats
  const total=IMAGE_DATA.reduce((s,i)=>s+i.size,0);
  const unused=IMAGE_DATA.filter(i=>i.pages.length===0).length;
  document.getElementById('stats').innerHTML=`<span><strong>${IMAGE_DATA.length}</strong> images</span><span><strong>${formatSize(total)}</strong></span><span><strong>${unused}</strong> unused</span><span>Showing <strong>${items.length}</strong></span>`;
}

function openLightbox(src){document.getElementById('lightbox-img').src=src;document.getElementById('lightbox').classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}

// ── Replace Modal ──
let currentTarget=null,newFile=null,newDataUrl=null,optimizedBlob=null;

function showReplace(name){
  const img=IMAGE_DATA.find(i=>i.name===name);if(!img)return;
  currentTarget=img;newFile=null;newDataUrl=null;optimizedBlob=null;
  document.getElementById('replaceTitle').textContent='Replace: '+img.name;
  document.getElementById('replaceCurrent').src='assets/images/'+img.name;
  document.getElementById('replaceNew').style.display='none';
  document.getElementById('replaceNewPlaceholder').style.display='flex';
  document.getElementById('btnDownload').disabled=true;
  document.getElementById('btnCommit').disabled=!getToken();
  document.getElementById('optAlt').value='';
  document.getElementById('optAlt').placeholder=img.alt;
  document.getElementById('replaceStatus').className='replace-status';
  document.getElementById('replaceStatus').style.display='none';
  const mw=document.getElementById('optMaxWidth');
  mw.value=img.type==='float'?600:img.type==='map'?800:1200;
  document.getElementById('optFormat').value='auto';
  document.getElementById('replaceModal').classList.add('active');
}

// Drag & Drop
const dz=document.getElementById('dropZone'),fi=document.getElementById('fileInput');
['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('drag-over')}));
['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('drag-over')}));
dz.addEventListener('drop',e=>{if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0])});
fi.addEventListener('change',e=>{if(e.target.files[0])handleFile(e.target.files[0]);e.target.value=''});

function handleFile(file){
  if(!file.type.match(/^image\/(jpeg|png|webp)$/)){showStatus('error','Select a JPG, PNG, or WebP image.');return}
  if(file.size>5*1024*1024){showStatus('error','File too large. Max 5 MB.');return}
  newFile=file;
  const reader=new FileReader();
  reader.onload=e=>{
    newDataUrl=e.target.result;
    document.getElementById('replaceNew').src=newDataUrl;
    document.getElementById('replaceNew').style.display='block';
    document.getElementById('replaceNewPlaceholder').style.display='none';
    document.getElementById('btnDownload').disabled=false;
    if(getToken())document.getElementById('btnCommit').disabled=false;
    showStatus('info',`Selected: ${file.name} (${formatSize(file.size)})`);
  };
  reader.readAsDataURL(file);
}

function showStatus(t,m){const el=document.getElementById('replaceStatus');el.className='replace-status '+t;el.textContent=m;el.style.display='block'}

// ── Process Image (download or commit) ──
function processImage(mode){
  if(!newFile||!currentTarget)return;
  const maxW=parseInt(document.getElementById('optMaxWidth').value)||1200;
  const qual=(parseInt(document.getElementById('optQuality').value)||80)/100;
  const fmtSel=document.getElementById('optFormat').value;

  showStatus('info','Processing image...');
  const img=new Image();
  img.onload=()=>{
    const canvas=document.createElement('canvas');
    let w=img.width,h=img.height;
    if(w>maxW){h=Math.round(h*(maxW/w));w=maxW}
    canvas.width=w;canvas.height=h;
    canvas.getContext('2d').drawImage(img,0,0,w,h);

    let mime,ext;
    if(fmtSel==='auto'){ext=getExt(currentTarget.name);mime=ext==='png'?'image/png':ext==='webp'?'image/webp':'image/jpeg';if(ext==='jpg'||ext==='jpeg')ext='jpg'}
    else{mime='image/'+fmtSel;ext=fmtSel==='jpeg'?'jpg':fmtSel}

    canvas.toBlob(blob=>{
      if(!blob){showStatus('error','Failed to process.');return}
      optimizedBlob=blob;
      if(mode==='download')downloadBlob(blob,ext,w,h);
      else if(mode==='commit')commitToGithub(blob,w,h);
    },mime,qual);
  };
  img.src=newDataUrl;
}

function downloadBlob(blob,ext,w,h){
  const target=currentTarget.name.includes('/')?currentTarget.name.split('/').pop():currentTarget.name;
  const base=target.substring(0,target.lastIndexOf('.'));
  const out=base+'.'+ext;
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=out;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  showStatus('success',`Downloaded "${out}" (${formatSize(blob.size)}, ${w}x${h})`);
}

async function commitToGithub(blob,w,h){
  const token=getToken();
  if(!token){showStatus('error','No GitHub token. Open settings to add one.');return}

  showStatus('info','Committing to GitHub...');
  const path='assets/images/'+currentTarget.name;
  const apiUrl=`https://api.github.com/repos/${REPO}/contents/${path}`;
  const headers={'Authorization':'token '+token,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'};

  try{
    // 1. Get current file SHA
    const getResp=await fetch(apiUrl+'?ref='+BRANCH,{headers});
    if(!getResp.ok)throw new Error('Failed to get file info: '+getResp.status);
    const fileInfo=await getResp.json();
    const sha=fileInfo.sha;

    // 2. Convert blob to base64
    const buf=await blob.arrayBuffer();
    const bytes=new Uint8Array(buf);
    let binary='';
    for(let i=0;i<bytes.length;i++)binary+=String.fromCharCode(bytes[i]);
    const b64=btoa(binary);

    // 3. Commit
    const newAlt=document.getElementById('optAlt').value.trim();
    const msg=`Replace ${currentTarget.name} (${formatSize(blob.size)}, ${w}x${h})${newAlt?' - update alt text':''}`;
    const putResp=await fetch(apiUrl,{method:'PUT',headers,body:JSON.stringify({message:msg,content:b64,sha:sha,branch:BRANCH})});
    if(!putResp.ok){const err=await putResp.json();throw new Error(err.message||'Commit failed')}

    const result=await putResp.json();
    showStatus('success',`Committed! ${currentTarget.name} replaced (${formatSize(blob.size)}, ${w}x${h}). SHA: ${result.content.sha.substring(0,7)}. Both EN and TR pages updated automatically.`);

    // Refresh the image in the gallery
    document.querySelectorAll(`img[src="assets/images/${currentTarget.name}"]`).forEach(el=>{el.src='assets/images/'+currentTarget.name+'?t='+Date.now()});
  }catch(err){
    showStatus('error','GitHub error: '+err.message);
  }
}

// ── Init ──
const ps=document.getElementById('filterPage');
getEnPages().forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=PAGE_TITLES[p]||p;ps.appendChild(o)});
document.getElementById('search').addEventListener('input',render);
document.getElementById('filterPage').addEventListener('change',render);
document.getElementById('filterType').addEventListener('change',render);
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.getElementById('lightbox').classList.remove('active');closeModal('replaceModal');document.getElementById('settingsPanel').classList.remove('open');document.getElementById('settingsBtn').classList.remove('active')}});
document.addEventListener('click',e=>{const sp=document.getElementById('settingsPanel'),sb=document.getElementById('settingsBtn');if(sp.classList.contains('open')&&!sp.contains(e.target)&&!sb.contains(e.target)){sp.classList.remove('open');sb.classList.remove('active')}});

if(!checkAuth())document.getElementById('loginEmail').focus();
</script>
</body>
</html>
